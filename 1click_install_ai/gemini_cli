#!/bin/bash
# One-click Snap installer for Gemini CLI with compatibility checks
# Official requirements: Linux with snapd, systemd, and glibc 2.31+

set -e

# Colors for better readability
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }
log_debug() { echo -e "${BLUE}[DEBUG]${NC} $*"; }

# Check if Gemini CLI is already installed
check_gemini_installed() {
    log_info "Checking if Gemini CLI is already installed..."
    
    # Check via snap
    if snap list 2>/dev/null | grep -q "gemini-cli"; then
        log_info "✓ Gemini CLI is already installed via Snap"
        VERSION=$(snap info gemini-cli | grep "installed:" | awk '{print $2}')
        log_info "  Version: $VERSION"
        return 0
    fi
    
    # Check via npm
    if command -v gemini >/dev/null 2>&1; then
        log_info "✓ Gemini CLI is already installed (not via Snap)"
        if command -v npm >/dev/null 2>&1; then
            if npm list -g @google/gemini-cli 2>/dev/null | grep -q "@google/gemini-cli"; then
                log_info "  Installed via npm"
            fi
        fi
        return 0
    fi
    
    # Check for binary in PATH
    if which gemini >/dev/null 2>&1; then
        log_info "✓ Gemini CLI is already installed"
        log_info "  Location: $(which gemini)"
        return 0
    fi
    
    log_info "Gemini CLI is not installed"
    return 1
}

# Check OS compatibility
check_os_compatibility() {
    log_info "Checking OS compatibility..."
    
    # Check if Linux
    if [[ "$(uname -s)" != "Linux" ]]; then
        log_error "Snap is only supported on Linux"
        log_error "Detected OS: $(uname -s)"
        return 1
    fi
    
    # Check if /etc/os-release exists
    if [ ! -f /etc/os-release ]; then
        log_warn "Cannot determine Linux distribution"
        log_warn "Snap might not be supported on this system"
        return 2
    fi
    
    # Load OS info
    . /etc/os-release
    
    log_info "Detected: $NAME $VERSION (ID: $ID)"
    
    # Check for systemd (required for Snap)
    if ! command -v systemctl >/dev/null 2>&1; then
        log_error "systemd is required for Snap but not found"
        return 1
    fi
    
    # Check for glibc version (minimum 2.31 for modern Snap)
    if command -v ldd >/dev/null 2>&1; then
        LDD_VERSION=$(ldd --version 2>/dev/null | head -1 | grep -o '[0-9]\+\.[0-9]\+' | head -1)
        if [[ -n "$LDD_VERSION" ]]; then
            log_debug "glibc version: $LDD_VERSION"
            if [[ "$(printf '%s\n' "2.31" "$LDD_VERSION" | sort -V | head -1)" == "2.31" ]]; then
                log_info "✓ glibc version $LDD_VERSION meets minimum requirement (2.31+)"
            else
                log_warn "glibc version $LDD_VERSION might be too old (minimum 2.31 recommended)"
            fi
        fi
    fi
    
    # Official Snap support matrix check
    case $ID in
        ubuntu)
            if [[ "$VERSION_ID" == "20.04" ]] || [[ "$VERSION_ID" == "22.04" ]] || [[ "$VERSION_ID" == "24.04" ]]; then
                log_info "✓ Ubuntu $VERSION_ID is fully supported by Snap"
                return 0
            elif [[ $(echo "$VERSION_ID >= 16.04" | bc -l 2>/dev/null) -eq 1 ]] || [[ "$VERSION_ID" > "16.04" ]]; then
                log_info "✓ Ubuntu $VERSION_ID should support Snap"
                return 0
            else
                log_warn "Ubuntu $VERSION_ID might have limited Snap support"
                return 2
            fi
            ;;
        debian)
            if [[ "$VERSION_ID" == "10" ]] || [[ "$VERSION_ID" == "11" ]] || [[ "$VERSION_ID" == "12" ]]; then
                log_info "✓ Debian $VERSION_ID is fully supported by Snap"
                return 0
            elif [[ "$VERSION_ID" -ge 9 ]]; then
                log_info "✓ Debian $VERSION_ID should support Snap"
                return 0
            else
                log_error "Debian $VERSION_ID is too old for Snap"
                return 1
            fi
            ;;
        fedora)
            if [[ "$VERSION_ID" -ge 32 ]]; then
                log_info "✓ Fedora $VERSION_ID supports Snap"
                return 0
            else
                log_warn "Fedora $VERSION_ID might have limited Snap support"
                return 2
            fi
            ;;
        centos|rhel|rocky|almalinux)
            if [[ "$VERSION_ID" =~ ^7 ]] || [[ "$VERSION_ID" =~ ^8 ]] || [[ "$VERSION_ID" =~ ^9 ]]; then
                log_info "✓ $NAME $VERSION_ID supports Snap (requires EPEL)"
                return 0
            else
                log_warn "$NAME $VERSION_ID might have limited Snap support"
                return 2
            fi
            ;;
        arch|manjaro|endeavouros)
            log_info "✓ $NAME supports Snap (via AUR/pacman)"
            return 0
            ;;
        linuxmint|pop|elementary|neon|zorin)
            log_info "✓ $NAME (Ubuntu-based) supports Snap"
            return 0
            ;;
        *)
            log_warn "Distribution '$ID' is not officially listed in Snap documentation"
            log_warn "Snap might work but is not guaranteed"
            return 2
            ;;
    esac
}

# Install snapd if needed
install_snapd() {
    log_info "Checking for snapd..."
    
    if command -v snap >/dev/null 2>&1; then
        log_info "✓ snapd is already installed"
        SNAP_VERSION=$(snap --version | head -1)
        log_info "  Version: $SNAP_VERSION"
        return 0
    fi
    
    log_info "Installing snapd..."
    
    # Detect package manager and install snapd
    if command -v apt >/dev/null 2>&1; then
        # Debian/Ubuntu
        sudo apt update
        sudo apt install -y snapd
    elif command -v dnf >/dev/null 2>&1; then
        # Fedora/RHEL
        sudo dnf install -y snapd
        sudo ln -s /var/lib/snapd/snap /snap
    elif command -v yum >/dev/null 2>&1; then
        # CentOS/RHEL (older)
        sudo yum install -y epel-release
        sudo yum install -y snapd
        sudo ln -s /var/lib/snapd/snap /snap
    elif command -v pacman >/dev/null 2>&1; then
        # Arch Linux
        sudo pacman -S --noconfirm snapd
        sudo ln -s /var/lib/snapd/snap /snap
    elif command -v zypper >/dev/null 2>&1; then
        # openSUSE
        sudo zypper addrepo --refresh https://download.opensuse.org/repositories/system:/snappy/openSUSE_Leap_15.0 snappy
        sudo zypper --gpg-auto-import-keys refresh
        sudo zypper dup --from snappy
        sudo zypper install -y snapd
        sudo ln -s /var/lib/snapd/snap /snap
    else
        log_error "Cannot determine package manager"
        return 1
    fi
    
    # Enable snapd socket
    sudo systemctl enable --now snapd.socket
    sudo systemctl restart snapd.socket
    
    # Wait for snapd to be ready
    sleep 2
    
    if command -v snap >/dev/null 2>&1; then
        log_info "✓ snapd installed successfully"
        return 0
    else
        log_error "snapd installation failed"
        return 1
    fi
}

# Install core snap
install_core_snap() {
    log_info "Checking for core snap..."
    
    if snap list 2>/dev/null | grep -q "^core\s"; then
        log_info "✓ core snap is already installed"
        return 0
    fi
    
    log_info "Installing core snap..."
    if sudo snap install core; then
        log_info "✓ core snap installed successfully"
        return 0
    else
        log_error "Failed to install core snap"
        return 1
    fi
}

# Install Gemini CLI
install_gemini_cli() {
    log_info "Installing Gemini CLI via Snap..."
    
    if sudo snap install gemini-cli; then
        log_info "✓ Gemini CLI installed successfully via Snap"
        
        # Get version info
        if snap list | grep -q "gemini-cli"; then
            VERSION=$(snap info gemini-cli | grep "installed:" | awk '{print $2}')
            log_info "  Version: $VERSION"
            log_info "  Channel: $(snap info gemini-cli | grep "tracking:" | awk '{print $2}')"
        fi
        
        return 0
    else
        log_error "Failed to install Gemini CLI via Snap"
        
        # Check if package exists
        log_info "Searching for Gemini CLI in Snap store..."
        if snap find gemini-cli 2>&1 | grep -q "no snaps found"; then
            log_error "Package 'gemini-cli' not found in Snap store"
            log_info "Alternative installation methods:"
            log_info "  1. sudo npm install -g @google/gemini-cli"
            log_info "  2. Download from: https://ai.google.dev/gemini-api/docs/cli"
        fi
        
        return 1
    fi
}

# Set up PATH and aliases
setup_path() {
    log_info "Setting up environment..."
    
    # Add snap/bin to PATH in current shell
    export PATH="$PATH:/snap/bin"
    
    # Check if gemini command is available
    if command -v gemini >/dev/null 2>&1; then
        log_info "✓ Gemini CLI is now available in PATH"
        log_info "  Run: gemini --help"
        return 0
    else
        log_warn "Gemini CLI command not found in current PATH"
        log_info "You may need to:"
        log_info "  1. Log out and log back in"
        log_info "  2. Or run: export PATH=\$PATH:/snap/bin"
        log_info "  3. Or use: /snap/bin/gemini"
        return 1
    fi
}

# Main installation flow
main() {
    echo "================================================"
    echo "  Gemini CLI One-Click Installer (Snap)"
    echo "  Based on official Snap documentation"
    echo "================================================"
    echo
    
    # Check if already installed
    if check_gemini_installed; then
        log_info "Gemini CLI is already installed. Nothing to do."
        echo
        log_info "To update: sudo snap refresh gemini-cli"
        log_info "To remove:  sudo snap remove gemini-cli"
        exit 0
    fi
    
    # Check OS compatibility
    OS_COMPAT=$(check_os_compatibility)
    COMPAT_RESULT=$?
    
    if [[ $COMPAT_RESULT -eq 1 ]]; then
        log_error "System is not compatible with Snap"
        exit 1
    elif [[ $COMPAT_RESULT -eq 2 ]]; then
        echo
        log_warn "Proceed with installation? (y/N)"
        read -r response
        if [[ ! "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
            log_info "Installation cancelled"
            exit 0
        fi
    fi
    
    # Install snapd
    if ! install_snapd; then
        exit 1
    fi
    
    # Install core snap
    if ! install_core_snap; then
        exit 1
    fi
    
    # Install Gemini CLI
    if ! install_gemini_cli; then
        exit 1
    fi
    
    # Setup PATH
    setup_path
    
    echo
    log_info "================================================"
    log_info "Installation complete!"
    log_info "Quick test: /snap/bin/gemini --help"
    log_info "================================================"
}

# Check for sudo privileges
if [[ $EUID -eq 0 ]]; then
    log_warn "Running as root. It's better to run with sudo when needed."
    main
elif command -v sudo >/dev/null 2>&1; then
    log_info "This script requires sudo privileges"
    exec sudo bash "$0"
else
    log_error "sudo is not available. Please run as root."
    exit 1
fi
